<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Lead Formatter - MCAgent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 30px 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .header-top {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .back-btn {
            text-decoration: none;
            color: #007aff;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .back-btn:hover {
            opacity: 0.7;
        }

        h1 {
            color: #1d1d1f;
            font-size: 2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subtitle {
            color: #86868b;
            font-size: 1rem;
            font-weight: 400;
            margin-top: 8px;
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            margin-bottom: 24px;
            border: 1px solid rgba(0,0,0,0.04);
        }

        .upload-area {
            border: 2px dashed #007aff;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 24px;
        }

        .upload-area:hover {
            border-color: #0051d5;
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            transform: scale(1.01);
        }

        .upload-area.dragging {
            border-color: #34c759;
            background: linear-gradient(135deg, #d1f4e0 0%, #c1f0d5 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .upload-text {
            color: #1d1d1f;
            font-size: 1.2rem;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .upload-subtext {
            color: #86868b;
            font-size: 0.9rem;
        }

        input[type="file"] {
            display: none;
        }

        .webhook-config {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .webhook-config label {
            display: block;
            color: #1d1d1f;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .webhook-config input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d1d6;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
            background: white;
            font-family: inherit;
        }

        .webhook-config input:focus {
            outline: none;
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .status {
            padding: 14px 18px;
            border-radius: 10px;
            display: none;
            font-size: 0.9rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
        }

        .status.success {
            background: #d1f4e0;
            color: #1d7a3a;
            border: 1px solid #34c759;
        }

        .status.error {
            background: #ffe5e5;
            color: #d32f2f;
            border: 1px solid #ff3b30;
        }

        .status.show {
            display: block;
        }

        .download-section {
            display: none;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 20px;
            letter-spacing: -0.3px;
        }

        .download-buttons {
            display: grid;
            gap: 12px;
        }

        .download-btn {
            padding: 16px 20px;
            background: #007aff;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .download-btn:hover {
            background: #0051d5;
            transform: translateY(-2px);
        }

        .download-btn span {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: normal;
        }

        .instructions {
            background: #f5f5f7;
            padding: 20px;
            border-radius: 12px;
            display: none;
            margin-top: 24px;
        }

        .instructions h3 {
            color: #1d1d1f;
            margin-bottom: 12px;
            font-size: 1rem;
            font-weight: 600;
        }

        .instructions ol {
            margin-left: 20px;
            color: #6e6e73;
        }

        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            body {
                padding: 20px 16px;
            }

            .header {
                padding: 24px;
            }

            h1 {
                font-size: 1.6rem;
            }

            .card {
                padding: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <a href="../Main.html" class="back-btn">‚Üê Back to Home</a>
            </div>
            <h1>
                <span>üöÄ</span>
                CRM Lead Formatter
            </h1>
            <p class="subtitle">Transform your CSV files into CRM-ready format with intelligent parsing</p>
        </div>

        <div class="card">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">Click to upload CSV file</div>
                <div class="upload-subtext">or drag and drop here</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>

            <div class="webhook-config">
                <label for="webhookUrl">Webhook URL (optional - for server processing)</label>
                <input type="text" id="webhookUrl" placeholder="https://your-webhook-url.com/process">
            </div>

            <div id="status" class="status"></div>
        </div>

        <div class="card download-section" id="downloadSection">
            <h3 class="section-title">üì• Download Your Files</h3>
            <div class="download-buttons">
                <a href="#" id="crmDownload" class="download-btn" download>
                    CRM Import File
                    <span>Full formatted data</span>
                </a>
                <a href="#" id="nameOnlyDownload" class="download-btn" download>
                    Name Only File
                    <span>For mass texting</span>
                </a>
                <a href="#" id="phoneBurnerDownload" class="download-btn" download>
                    PhoneBurner Format
                    <span>Click-to-call platform</span>
                </a>
            </div>

            <div id="instructions" class="instructions">
                <h3>üìã Broker Instructions</h3>
                <ol>
                    <li><strong>Name Only File:</strong> Send to your iPhone for mass texting</li>
                    <li><strong>CRM Import File:</strong> Import into the CRM system</li>
                    <li>Complete both steps before proceeding</li>
                    <li>Add responsive files into MCA Underwriting for FCS report</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const webhookUrl = document.getElementById('webhookUrl');
        const status = document.getElementById('status');
        const downloadSection = document.getElementById('downloadSection');
        const instructions = document.getElementById('instructions');

        // Drag and drop handlers
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');

            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                handleFile(files[0]);
            } else {
                showStatus('Please upload a CSV file', 'error');
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type} show`;
        }

        function formatPhoneNumber(phone) {
            if (!phone) return '';
            return phone.replace(/\D/g, '').slice(0, 10);
        }

        function formatDate(date) {
            if (!date) return '';

            const monthNames = {
                'january': '01', 'jan': '01',
                'february': '02', 'feb': '02',
                'march': '03', 'mar': '03',
                'april': '04', 'apr': '04',
                'may': '05',
                'june': '06', 'jun': '06',
                'july': '07', 'jul': '07',
                'august': '08', 'aug': '08',
                'september': '09', 'sep': '09', 'sept': '09',
                'october': '10', 'oct': '10',
                'november': '11', 'nov': '11',
                'december': '12', 'dec': '12'
            };

            date = date.trim();

            const monthNamePattern = /^([a-zA-Z]+)\s+(\d{1,2}),?\s+(\d{4})$/;
            const monthNameMatch = date.match(monthNamePattern);

            if (monthNameMatch) {
                const monthName = monthNameMatch[1].toLowerCase();
                const day = monthNameMatch[2];
                const year = monthNameMatch[3];

                if (monthNames[monthName]) {
                    const month = monthNames[monthName];
                    return `${month}-${day.padStart(2, '0')}-${year}`;
                }
            }

            const dayFirstPattern = /^(\d{1,2})\s+([a-zA-Z]+)\s+(\d{4})$/;
            const dayFirstMatch = date.match(dayFirstPattern);

            if (dayFirstMatch) {
                const day = dayFirstMatch[1];
                const monthName = dayFirstMatch[2].toLowerCase();
                const year = dayFirstMatch[3];

                if (monthNames[monthName]) {
                    const month = monthNames[monthName];
                    return `${month}-${day.padStart(2, '0')}-${year}`;
                }
            }

            if (date.includes('/')) {
                const parts = date.split('/');
                if (parts.length === 3) {
                    let month, day, year;

                    if (parseInt(parts[0]) > 12) {
                        day = parts[0].padStart(2, '0');
                        month = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }
                    else if (parseInt(parts[1]) > 12) {
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }
                    else {
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }

                    const dateObj = new Date(year, month - 1, day);
                    if (!isNaN(dateObj)) {
                        return `${month}-${day}-${year}`;
                    }
                }
            }

            if (date.includes('-')) {
                const parts = date.split('-');
                if (parts.length === 3) {
                    let month, day, year;

                    if (parts[0].length === 4) {
                        year = parts[0];
                        month = parts[1].padStart(2, '0');
                        day = parts[2].padStart(2, '0');
                    }
                    else if (parseInt(parts[0]) > 12) {
                        day = parts[0].padStart(2, '0');
                        month = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }
                    else if (parseInt(parts[1]) > 12) {
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }
                    else {
                        month = parts[0].padStart(2, '0');
                        day = parts[1].padStart(2, '0');
                        year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                    }

                    return `${month}-${day}-${year}`;
                }
            }

            if (/^\d{8}$/.test(date) && date.substring(0, 4) >= 1900) {
                const year = date.substring(0, 4);
                const month = date.substring(4, 6);
                const day = date.substring(6, 8);
                return `${month}-${day}-${year}`;
            }

            if (/^\d{8}$/.test(date)) {
                const month = date.substring(0, 2);
                const day = date.substring(2, 4);
                const year = date.substring(4, 8);
                if (parseInt(month) >= 1 && parseInt(month) <= 12) {
                    return `${month}-${day}-${year}`;
                }
            }

            const dateObj = new Date(date);
            if (!isNaN(dateObj)) {
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const year = dateObj.getFullYear();
                return `${month}-${day}-${year}`;
            }

            console.warn(`Could not parse date: "${date}"`);
            return date;
        }

        function formatSSN(ssn) {
            if (!ssn) return '';
            const cleaned = ssn.replace(/\D/g, '');
            if (cleaned.length === 9) {
                return `${cleaned.slice(0, 3)}-${cleaned.slice(3, 5)}-${cleaned.slice(5)}`;
            }
            return ssn;
        }

        function formatNameToProperCase(name) {
            if (!name) return '';

            if (name.includes('-')) {
                return name.split('-')
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())
                    .join('-');
            }

            if (name.includes("'")) {
                const parts = name.split("'");
                return parts.map((part, index) => {
                    if (index === 0 || part.length > 0) {
                        return part.charAt(0).toUpperCase() + part.slice(1).toLowerCase();
                    }
                    return part;
                }).join("'");
            }

            return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
        }

        function processCSV(csvText) {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js';

            return new Promise((resolve) => {
                script.onload = () => {
                    const result = Papa.parse(csvText, {
                        header: true,
                        skipEmptyLines: true,
                        dynamicTyping: false,
                        transformHeader: (header) => header.trim(),
                        transform: (value) => value ? value.trim() : ''
                    });

                    console.log('Parsed headers:', result.meta.fields);
                    console.log('Sample parsed row:', result.data[0]);

                    if (result.errors.length > 0) {
                        console.warn('CSV parsing warnings:', result.errors);
                    }

                    resolve({
                        headers: result.meta.fields,
                        data: result.data
                    });
                };

                script.onerror = () => {
                    console.log('Papa Parse failed to load, using fallback parser');
                    resolve(manualCSVParse(csvText));
                };

                document.head.appendChild(script);
            });
        }

        function manualCSVParse(csvText) {
            const lines = csvText.split(/\r?\n/);
            const headers = [];
            const data = [];

            if (lines.length > 0) {
                headers.push(...lines[0].split(',').map(h => h.trim()));
            }

            const expectedColumns = headers.length;

            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;

                const values = [];
                let current = '';
                let inQuotes = false;

                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                if (values.length !== expectedColumns) {
                    console.error(`Row ${i + 1} has ${values.length} columns, expected ${expectedColumns}.`);
                }

                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });

                data.push(row);
            }

            return { headers, data };
        }

        function createCRMFile(data) {
            const crmHeaders = [
                'First Name', 'Last Name', 'Phone Number', 'Cell Phone',
                'Company Name', 'Email', 'Lead Source', 'Address',
                'City', 'State', 'Zip', 'Business Type', 'Annual Revenue',
                'Funding', 'Factor Rate', 'Funding Date', 'Term', 'Notes',
                'Campaign', 'TaxID', 'SSN', 'Business Start Date', 'DOB'
            ];

            const rows = [crmHeaders.join(',')];

            data.forEach((row, index) => {
                const ownerName = row['Owner Name'] || '';

                const ssnPattern = /^\d{3}-?\d{2}-?\d{4}$/;
                if (ssnPattern.test(ownerName.replace(/\s/g, ''))) {
                    console.error(`Row ${index + 2}: SSN found in Owner Name field!`);
                }

                if (/^\d{9,}$/.test(ownerName.replace(/\D/g, ''))) {
                    console.error(`Row ${index + 2}: Owner Name contains only numbers.`);
                }

                const nameParts = ownerName.trim().split(/\s+/);
                const firstName = nameParts[0] || '';
                const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';

                const mobilePhone = formatPhoneNumber(row['Mobile'] || '');
                const officePhone = formatPhoneNumber(row['Phone Number'] || '');
                const phone = mobilePhone || officePhone;

                const crmRow = [
                    firstName,
                    lastName,
                    phone,
                    phone,
                    row['Company Name'] || '',
                    row['Email'] || '',
                    'WEB',
                    row['Address'] || '',
                    row['City'] || '',
                    row['State'] || '',
                    row['Zip'] || '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    '',
                    row['Monthly Revenue'] || '',
                    '',
                    row['TaxID'] || '',
                    formatSSN(row['SSN'] || ''),
                    formatDate(row['Business Start Date'] || ''),
                    formatDate(row['DOB'] || '')
                ];

                rows.push(crmRow.map(val => `"${val}"`).join(','));
            });

            return rows.join('\n');
        }

        function createNameOnlyFile(data) {
            const rows = [];

            data.forEach(row => {
                const ownerName = row['Owner Name'] || '';
                const nameParts = ownerName.trim().split(/\s+/);
                const firstName = nameParts[0] || '';

                const formattedFirstName = formatNameToProperCase(firstName);

                const mobilePhone = formatPhoneNumber(row['Mobile'] || '');
                const officePhone = formatPhoneNumber(row['Phone Number'] || '');
                const phone = mobilePhone || officePhone;

                if (formattedFirstName && phone && !/^\d+$/.test(formattedFirstName)) {
                    rows.push(`${formattedFirstName},${phone}`);
                }
            });

            return rows.join('\n');
        }

        function createPhoneBurnerFile(data) {
            const headers = ['First Name', 'Last Name', 'Phone', 'Company', 'Email'];
            const rows = [headers.join(',')];

            data.forEach(row => {
                const ownerName = row['Owner Name'] || '';
                const nameParts = ownerName.trim().split(/\s+/);
                const firstName = nameParts[0] || '';
                const lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : '';

                const mobilePhone = formatPhoneNumber(row['Mobile'] || '');
                const officePhone = formatPhoneNumber(row['Phone Number'] || '');
                const phone = mobilePhone || officePhone;

                if (firstName && !/^\d+$/.test(firstName)) {
                    const pbRow = [
                        firstName,
                        lastName,
                        phone,
                        row['Company Name'] || '',
                        row['Email'] || ''
                    ];

                    rows.push(pbRow.map(val => `"${val}"`).join(','));
                }
            });

            return rows.join('\n');
        }

        async function handleFile(file) {
            showStatus('Processing file... üîÑ', 'processing');

            const reader = new FileReader();
            reader.onload = async (e) => {
                const csvText = e.target.result;
                const { data } = await processCSV(csvText);

                if (webhookUrl.value) {
                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        const response = await fetch(webhookUrl.value, {
                            method: 'POST',
                            body: formData
                        });

                        if (response.ok) {
                            const result = await response.json();

                            if (result.crmFile && result.nameOnlyFile && result.phoneBurnerFile) {
                                setupDownloads(result.crmFile, result.nameOnlyFile, result.phoneBurnerFile);
                                showStatus('Files processed successfully! ‚úÖ', 'success');
                            } else {
                                throw new Error('Invalid response from webhook');
                            }
                        } else {
                            throw new Error('Webhook processing failed');
                        }
                    } catch (error) {
                        console.error('Webhook error:', error);
                        processLocally(data);
                    }
                } else {
                    processLocally(data);
                }
            };

            reader.readAsText(file);
        }

        function processLocally(data) {
            const crmFile = createCRMFile(data);
            const nameOnlyFile = createNameOnlyFile(data);
            const phoneBurnerFile = createPhoneBurnerFile(data);

            setupDownloads(crmFile, nameOnlyFile, phoneBurnerFile);
            showStatus('Files processed successfully! ‚úÖ', 'success');
        }

        function setupDownloads(crmFile, nameOnlyFile, phoneBurnerFile) {
            const crmBlob = new Blob([crmFile], { type: 'text/csv' });
            const nameOnlyBlob = new Blob([nameOnlyFile], { type: 'text/csv' });
            const phoneBurnerBlob = new Blob([phoneBurnerFile], { type: 'text/csv' });

            document.getElementById('crmDownload').href = URL.createObjectURL(crmBlob);
            document.getElementById('crmDownload').download = 'crm_import_' + Date.now() + '.csv';

            document.getElementById('nameOnlyDownload').href = URL.createObjectURL(nameOnlyBlob);
            document.getElementById('nameOnlyDownload').download = 'name_only_' + Date.now() + '.csv';

            document.getElementById('phoneBurnerDownload').href = URL.createObjectURL(phoneBurnerBlob);
            document.getElementById('phoneBurnerDownload').download = 'phoneburner_' + Date.now() + '.csv';

            downloadSection.style.display = 'block';
            instructions.style.display = 'block';
        }
    </script>
</body>
</html>
